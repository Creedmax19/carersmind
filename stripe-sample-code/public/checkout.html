<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://js.stripe.com/basil/stripe.js"></script>
  </head>
  <body>
    <header>
      <img src="https://carersmind.com/wp-content/uploads/2023/08/carers-mind-logo-1.png" alt="Carer's Mind Logo" class="logo">
    </header>
    
    <div class="cart-container">
      <div class="cart-header">
        <h1>Shopping Cart</h1>
        <div class="cart-summary">
          <span id="cart-total-items">0 items</span>
          <span id="cart-total-price">$0.00</span>
        </div>
      </div>
      <div id="cart-items">
        <!-- Cart items will be dynamically added here -->
      </div>
      <div class="cart-actions">
        <button id="checkout-button" class="btn-primary">Proceed to Checkout</button>
      </div>
    </div>

    <div class="product-catalog">
      <h2>Available Products</h2>
      <div class="products-grid">
        <!-- Product catalog will be dynamically populated -->
      </div>
    </div>

    <script>
      // Product catalog
      const products = [
        {
          id: '1',
          name: "Carer's Mind Membership",
          priceId: 'price_1RvIzyAbgyHA5Xcovgow97xz',
          price: 29.99,
          image: 'https://carersmind.com/wp-content/uploads/2023/08/carers-mind-logo-1.png'
        },
        {
          id: '2',
          name: "Carer's Mind Support Package",
          priceId: 'price_1RvIzyAbgyHA5Xcovgow97xz',
          price: 49.99,
          image: 'https://carersmind.com/wp-content/uploads/2023/08/carers-mind-logo-1.png'
        },
        {
          id: '3',
          name: "Carer's Mind Training Course",
          priceId: 'price_1RvIzyAbgyHA5Xcovgow97xz',
          price: 99.99,
          image: 'https://carersmind.com/wp-content/uploads/2023/08/carers-mind-logo-1.png'
        }
      ];

      // Cart state management
      let cart = JSON.parse(localStorage.getItem('cart') || '[]');

      // DOM Elements
      const cartItemsContainer = document.getElementById('cart-items');
      const productsGrid = document.querySelector('.products-grid');
      const checkoutButton = document.getElementById('checkout-button');

      // Update cart display
      function updateCartDisplay() {
        cartItemsContainer.innerHTML = '';
        let totalItems = 0;
        let totalPrice = 0;

        cart.forEach(item => {
          const product = products.find(p => p.id === item.productId);
          if (product) {
            totalItems += item.quantity;
            totalPrice += product.price * item.quantity;

            const cartItem = document.createElement('div');
            cartItem.className = 'cart-item';
            cartItem.innerHTML = `
              <img src="${product.image}" alt="${product.name}" class="cart-item-image">
              <div class="cart-item-details">
                <h3>${product.name}</h3>
                <p>$${product.price.toFixed(2)} each</p>
                <div class="quantity-controls">
                  <button onclick="updateQuantity('${item.productId}', -1)">-</button>
                  <span>${item.quantity}</span>
                  <button onclick="updateQuantity('${item.productId}', 1)">+</button>
                </div>
                <p>Total: $${(product.price * item.quantity).toFixed(2)}</p>
                <button onclick="removeFromCart('${item.productId}')" class="remove-button">Remove</button>
              </div>
            `;
            cartItemsContainer.appendChild(cartItem);
          }
        });

        // Update cart summary
        document.getElementById('cart-total-items').textContent = `${totalItems} item${totalItems !== 1 ? 's' : ''}`;
        document.getElementById('cart-total-price').textContent = `$${totalPrice.toFixed(2)}`;
      }
      }

      // Update quantity
      function updateQuantity(productId, change) {
        const itemIndex = cart.findIndex(item => item.productId === productId);
        if (itemIndex !== -1) {
          cart[itemIndex].quantity += change;
          if (cart[itemIndex].quantity <= 0) {
            cart.splice(itemIndex, 1);
          }
          saveCart();
          updateCartDisplay();
        }
      }

      // Remove from cart
      function removeFromCart(productId) {
        cart = cart.filter(item => item.productId !== productId);
        saveCart();
        updateCartDisplay();
      }

      // Save cart to localStorage
      function saveCart() {
        localStorage.setItem('cart', JSON.stringify(cart));
      }

      // Add to cart
      function addToCart(productId) {
        const existingItem = cart.find(item => item.productId === productId);
        if (existingItem) {
          existingItem.quantity++;
        } else {
          cart.push({ productId, quantity: 1 });
        }
        saveCart();
        updateCartDisplay();
      }

      // Populate product catalog
      function populateProductCatalog() {
        productsGrid.innerHTML = '';
        products.forEach(product => {
          const productCard = document.createElement('div');
          productCard.className = 'product-card';
          productCard.innerHTML = `
            <img src="${product.image}" alt="${product.name}">
            <h3>${product.name}</h3>
            <p>$${product.price.toFixed(2)}</p>
            <button onclick="addToCart('${product.id}')">Add to Cart</button>
          `;
          productsGrid.appendChild(productCard);
        });
      }

      // Initialize cart
      function initializeCart() {
        updateCartDisplay();
        populateProductCatalog();
      }

      // Handle checkout
      checkoutButton.onclick = async () => {
        // Create cart data for Stripe
        const cartData = cart.map(item => {
          const product = products.find(p => p.id === item.productId);
          return {
            price: product.priceId,
            quantity: item.quantity
          };
        });

        // Send cart data to server
        const response = await fetch('http://localhost:4243/create-checkout-session', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ items: cartData })
        });

        if (response.ok) {
          const session = await response.json();
          window.location.href = session.url;
        } else {
          console.error('Error creating checkout session');
        }
      };

      // Initialize the cart when page loads
      initializeCart();
    </script>
  </body>
</html>